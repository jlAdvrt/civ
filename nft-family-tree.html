<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FishTank Civilization - NFT Family Tree</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #87CEEB 0%, #98D8E8 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 40px;
            gap: 20px;
        }

        .header h1 {
            font-size: 2.5em;
            color: #8B4513;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #D4AF37, #FFD700);
            padding: 15px 30px;
            border-radius: 15px;
            border: 3px solid #8B4513;
        }

        .civilization-icons {
            display: flex;
            gap: 10px;
            font-size: 2em;
        }

        .dynasties-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .dynasty {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 3px solid #D4AF37;
        }

        .dynasty-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .dynasty-title {
            font-size: 1.8em;
            color: #8B4513;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .founding-father {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }

        .character-portrait {
            position: relative;
            width: 140px;
            height: 140px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 5px solid #D4AF37;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 0 0 20px rgba(212, 175, 55, 0.4);
            overflow: hidden;
            background: linear-gradient(145deg, #2a2a2a, #404040);
        }

        .character-portrait:hover {
            transform: scale(1.15) rotate(3deg);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4), 0 0 30px rgba(255, 215, 0, 0.6);
            border-color: #FFD700;
            filter: brightness(1.1);
        }

        .portrait-avatar {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            border-radius: 15px;
        }

        /* Dynamic NFT backgrounds based on rarity */
        .bg-common {
            background: linear-gradient(145deg, #757575, #9E9E9E);
        }

        .bg-uncommon {
            background: linear-gradient(145deg, #2E7D32, #4CAF50, #66BB6A);
            box-shadow: inset 0 0 20px rgba(76, 175, 80, 0.3);
        }

        .bg-rare {
            background: linear-gradient(145deg, #1565C0, #2196F3, #42A5F5);
            box-shadow: inset 0 0 20px rgba(33, 150, 243, 0.4);
        }

        .bg-epic {
            background: linear-gradient(145deg, #6A1B9A, #9C27B0, #BA68C8);
            box-shadow: inset 0 0 25px rgba(156, 39, 176, 0.5);
        }

        .bg-legendary {
            background: linear-gradient(145deg, #E65100, #FF9800, #FFB74D, #FFD54F);
            box-shadow: inset 0 0 30px rgba(255, 152, 0, 0.6);
            animation: legendaryShimmer 4s ease-in-out infinite;
        }

        .bg-mythic {
            background: linear-gradient(145deg, #B71C1C, #F44336, #EF5350, #FF8A80, #FFD700);
            box-shadow: inset 0 0 35px rgba(244, 67, 54, 0.7);
            animation: mythicRainbow 3s linear infinite;
        }

        @keyframes legendaryShimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes mythicRainbow {
            0% { filter: hue-rotate(0deg) saturate(1.2); }
            25% { filter: hue-rotate(90deg) saturate(1.4); }
            50% { filter: hue-rotate(180deg) saturate(1.6); }
            75% { filter: hue-rotate(270deg) saturate(1.4); }
            100% { filter: hue-rotate(360deg) saturate(1.2); }
        }

        .character-body {
            width: 90px;
            height: 110px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .character-head {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            margin: 5px auto 8px;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3), 0 2px 8px rgba(0,0,0,0.2);
            border: 2px solid rgba(255,255,255,0.1);
        }

        .character-torso {
            width: 40px;
            height: 45px;
            margin: 0 auto 5px;
            position: relative;
            border-radius: 8px 8px 12px 12px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3), 0 2px 6px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .character-arms {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 55px;
            height: 8px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .character-arms::before,
        .character-arms::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            top: -2px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .character-arms::before {
            left: -6px;
        }

        .character-arms::after {
            right: -6px;
        }

        .character-legs {
            display: flex;
            gap: 8px;
            margin-top: 3px;
        }

        .character-leg {
            width: 14px;
            height: 25px;
            border-radius: 7px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.3), 0 1px 3px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .character-leg::after {
            content: '';
            display: block;
            width: 10px;
            height: 8px;
            border-radius: 50%;
            margin: auto;
            margin-top: 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .character-info {
            text-align: center;
            margin-top: 10px;
        }

        .character-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #8B4513;
            margin-bottom: 5px;
        }

        .character-dates {
            font-size: 0.9em;
            color: #666;
            line-height: 1.3;
        }

        .birth-date {
            color: #4CAF50;
        }

        .death-date {
            color: #F44336;
        }

        .status-alive {
            background: linear-gradient(145deg, #4CAF50, #8BC34A);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
        }

        .status-dead {
            background: linear-gradient(145deg, #424242, #616161);
            opacity: 0.8;
            filter: grayscale(30%);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
        }

        /* Special effect animations */
        .effect-glow {
            animation: nftGlow 3s ease-in-out infinite alternate;
        }

        .effect-shimmer {
            animation: nftShimmer 2s linear infinite;
        }

        .effect-pulse {
            animation: nftPulse 1.5s ease-in-out infinite;
        }

        @keyframes nftGlow {
            0% { box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 0 0 20px rgba(212, 175, 55, 0.4); }
            100% { box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 0 0 40px rgba(212, 175, 55, 0.8); }
        }

        @keyframes nftShimmer {
            0% { filter: brightness(1) hue-rotate(0deg); }
            50% { filter: brightness(1.2) hue-rotate(180deg); }
            100% { filter: brightness(1) hue-rotate(360deg); }
        }

        @keyframes nftPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .descendants {
            position: relative;
        }

        .connection-line {
            position: absolute;
            background: #8B4513;
            z-index: 1;
        }

        .vertical-line {
            width: 3px;
            left: 50%;
            transform: translateX(-50%);
        }

        .horizontal-line {
            height: 3px;
            top: 50%;
            transform: translateY(-50%);
        }

        .generation {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .descendant-portrait {
            width: 100px;
            height: 100px;
        }

        .descendant-portrait .character-body {
            width: 65px;
            height: 80px;
        }

        .descendant-portrait .character-head {
            width: 25px;
            height: 25px;
        }

        .descendant-portrait .character-torso {
            width: 28px;
            height: 32px;
        }

        .descendant-portrait .character-arms {
            width: 40px;
            height: 6px;
            top: 12px;
        }

        .descendant-portrait .character-arms::before,
        .descendant-portrait .character-arms::after {
            width: 8px;
            height: 8px;
        }

        .descendant-portrait .character-leg {
            width: 10px;
            height: 18px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #fff, #f8f9fa);
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            border: 3px solid #D4AF37;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            color: #999;
            float: right;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 10px;
        }

        .close:hover {
            color: #666;
        }

        .modal-portrait {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .modal-avatar {
            width: 100px;
            height: 100px;
            border-radius: 15px;
            border: 3px solid #D4AF37;
        }

        .modal-basic-info h2 {
            color: #8B4513;
            margin-bottom: 10px;
        }

        .modal-basic-info p {
            margin: 5px 0;
            color: #666;
        }

        .modal-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .detail-card {
            background: rgba(212, 175, 55, 0.1);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #D4AF37;
        }

        .detail-label {
            font-weight: bold;
            color: #8B4513;
            margin-bottom: 5px;
        }

        .detail-value {
            color: #333;
        }

        .interactions-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(135, 206, 235, 0.1);
            border-radius: 10px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #8B4513;
        }

        .error {
            text-align: center;
            padding: 30px;
            background: rgba(244, 67, 54, 0.1);
            border-radius: 10px;
            color: #F44336;
            margin: 20px;
        }

        .nft-rarity {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4), inset 0 1px 2px rgba(255,255,255,0.3);
            z-index: 20;
        }

        .nft-rarity::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.8);
        }

        .rarity-common {
            background: linear-gradient(145deg, #9E9E9E, #757575);
            border-color: #BDBDBD;
        }
        .rarity-uncommon {
            background: linear-gradient(145deg, #4CAF50, #388E3C);
            border-color: #81C784;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4), inset 0 1px 2px rgba(255,255,255,0.3);
        }
        .rarity-rare {
            background: linear-gradient(145deg, #2196F3, #1976D2);
            border-color: #64B5F6;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.4), inset 0 1px 2px rgba(255,255,255,0.3);
        }
        .rarity-epic {
            background: linear-gradient(145deg, #9C27B0, #7B1FA2);
            border-color: #CE93D8;
            box-shadow: 0 2px 8px rgba(156, 39, 176, 0.4), inset 0 1px 2px rgba(255,255,255,0.3);
        }
        .rarity-legendary {
            background: linear-gradient(145deg, #FF9800, #F57C00);
            border-color: #FFB74D;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.4), inset 0 1px 2px rgba(255,255,255,0.3);
            animation: legendaryGlow 2s ease-in-out infinite alternate;
        }
        .rarity-mythic {
            background: linear-gradient(145deg, #F44336, #D32F2F);
            border-color: #EF5350;
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.4), inset 0 1px 2px rgba(255,255,255,0.3);
            animation: mythicPulse 1.5s ease-in-out infinite;
        }

        @keyframes legendaryGlow {
            0% { box-shadow: 0 2px 8px rgba(255, 152, 0, 0.4), 0 0 10px rgba(255, 152, 0, 0.3); }
            100% { box-shadow: 0 2px 8px rgba(255, 152, 0, 0.6), 0 0 20px rgba(255, 152, 0, 0.5); }
        }

        @keyframes mythicPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .generation-label {
            text-align: center;
            font-weight: bold;
            color: #8B4513;
            margin: 15px 0 10px;
            font-size: 1.1em;
        }

        /* NFT Accessories and clothing with professional quality */
        .nft-hat {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 15px;
            border-radius: 20px 20px 8px 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4), inset 0 1px 2px rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            z-index: 10;
        }

        .nft-hat::before {
            content: '';
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: 35px;
            height: 3px;
            background: rgba(0,0,0,0.3);
            border-radius: 2px;
        }

        .nft-shirt {
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            height: 30px;
            border-radius: 6px 6px 8px 8px;
            box-shadow: inset 0 2px 4px rgba(255,255,255,0.2), 0 2px 4px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .nft-shirt::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 2px;
            background: rgba(0,0,0,0.2);
            border-radius: 1px;
        }

        .nft-pants {
            width: 100%;
            height: 100%;
            border-radius: 6px;
            box-shadow: inset 0 2px 4px rgba(255,255,255,0.1), 0 1px 3px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .nft-pants::before {
            content: '';
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 1px;
            background: rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="civilization-icons">
            <span>‚öõÔ∏è</span>
            <span>üî•</span>
            <span>üî®</span>
            <span>üåæ</span>
            <span>‚öîÔ∏è</span>
        </div>
        <h1>üèõÔ∏è CIVILIZATION NFT FAMILY TREE üèõÔ∏è</h1>
        <div class="civilization-icons">
            <span>üèÉ</span>
            <span>üèÉ</span>
            <span>‚öîÔ∏è</span>
            <span>üèÉ</span>
            <span>üèÉ</span>
        </div>
    </div>

    <div id="loading" class="loading">
        <div>üé® Generating NFT Character Portraits...</div>
    </div>

    <div id="error" class="error" style="display: none;"></div>

    <div id="dynasties-container" class="dynasties-container" style="display: none;"></div>

    <!-- Character Details Modal -->
    <div id="characterModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // Detect if running locally vs deployed
        const isLocalFile = window.location.protocol === 'file:';
        const USE_STATIC_DATA = !isLocalFile; // Use static data only when deployed, not for local file testing
        const API_BASE = window.location.protocol + '//' + window.location.host;
        let allCharacters = [];
        let foundingFathers = [];

        // Professional NFT trait system with advanced rarity distribution
        const NFT_TRAITS = {
            hatColors: {
                common: ['#8B4513', '#654321', '#A0522D'],
                uncommon: ['#FF6B6B', '#4ECDC4', '#45B7D1'],
                rare: ['#96CEB4', '#FFEAA7', '#DDA0DD'],
                epic: ['#F4A460', '#98FB98', '#FFD700'],
                legendary: ['#FF69B4', '#00CED1', '#DA70D6'],
                mythic: ['#FF1493', '#00FFFF', '#ADFF2F']
            },
            shirtColors: {
                common: ['#696969', '#2F4F4F', '#8FBC8F'],
                uncommon: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'],
                rare: ['#FFEAA7', '#DDA0DD', '#F4A460', '#98FB98'],
                epic: ['#FFD700', '#FF69B4', '#00CED1'],
                legendary: ['#DA70D6', '#FF1493', '#00FFFF'],
                mythic: ['#ADFF2F', '#FF4500', '#9370DB']
            },
            pantsColors: {
                common: ['#2C3E50', '#34495E', '#2F4F4F'],
                uncommon: ['#8B4513', '#556B2F', '#800080'],
                rare: ['#CD853F', '#4682B4', '#8B008B'],
                epic: ['#B22222', '#228B22', '#4B0082'],
                legendary: ['#DC143C', '#FF8C00', '#9932CC'],
                mythic: ['#FF0000', '#00FF00', '#8A2BE2']
            },
            skinTones: ['#FDBCB4', '#EEA4A6', '#D08B5B', '#AE5D29', '#614335', '#F5DEB3', '#DEB887'],
            rarityWeights: {
                common: 50,
                uncommon: 25,
                rare: 15,
                epic: 7,
                legendary: 2.5,
                mythic: 0.5
            },
            specialEffects: {
                legendary: ['glow', 'shimmer'],
                mythic: ['pulse', 'rainbow', 'lightning']
            }
        };

        function generateNFTTraits(character) {
            // Use character address as seed for consistent traits
            const seed = character.address.slice(-8);
            const hashSeed = seed.split('').reduce((a, b) => a + b.charCodeAt(0), 0);

            // Generate rarity based on weighted distribution
            const rarity = determineRarity(hashSeed);

            // Generate traits based on rarity
            const hatColors = NFT_TRAITS.hatColors[rarity];
            const shirtColors = NFT_TRAITS.shirtColors[rarity];
            const pantsColors = NFT_TRAITS.pantsColors[rarity];

            return {
                hat: hatColors[hashSeed % hatColors.length],
                shirt: shirtColors[(hashSeed * 2) % shirtColors.length],
                pants: pantsColors[(hashSeed * 3) % pantsColors.length],
                skin: NFT_TRAITS.skinTones[(hashSeed * 4) % NFT_TRAITS.skinTones.length],
                rarity: rarity,
                hasHat: (hashSeed % 4) !== 0, // 75% chance
                hasShirt: (hashSeed % 3) !== 0, // 66% chance
                hasPants: (hashSeed % 2) === 0, // 50% chance
                specialEffect: NFT_TRAITS.specialEffects[rarity] ?
                    NFT_TRAITS.specialEffects[rarity][(hashSeed * 5) % NFT_TRAITS.specialEffects[rarity].length] : null
            };
        }

        function determineRarity(seed) {
            const rand = (seed * 9301 + 49297) % 233280;
            const percent = (rand / 233280) * 100;

            let cumulative = 0;
            for (const [rarity, weight] of Object.entries(NFT_TRAITS.rarityWeights)) {
                cumulative += weight;
                if (percent <= cumulative) {
                    return rarity;
                }
            }
            return 'common';
        }

        function createCharacterPortrait(character, isFounder = false) {
            const traits = generateNFTTraits(character);
            const portraitSize = isFounder ? 'character-portrait' : 'character-portrait descendant-portrait';

            return `
                <div class="${portraitSize} ${character.is_alive ? 'status-alive' : 'status-dead'} ${traits.specialEffect ? `effect-${traits.specialEffect}` : ''}"
                     onclick="openCharacterModal('${character.id}')"
                     data-character-id="${character.id}">

                    <div class="nft-rarity rarity-${traits.rarity}"></div>

                    <div class="portrait-avatar bg-${traits.rarity}">
                        <div class="character-body">
                            <div class="character-head" style="background: ${traits.skin};">
                                ${traits.hasHat ? `<div class="nft-hat" style="background: ${traits.hat};"></div>` : ''}
                            </div>
                            <div class="character-torso" style="background: ${traits.skin};">
                                ${traits.hasShirt ? `<div class="nft-shirt" style="background: ${traits.shirt};"></div>` : ''}
                                <div class="character-arms" style="background: ${traits.skin};"></div>
                            </div>
                            <div class="character-legs">
                                <div class="character-leg" style="background: ${traits.hasPants ? traits.pants : traits.skin};">
                                    ${traits.hasPants ? `<div class="nft-pants" style="background: ${traits.pants};"></div>` : ''}
                                </div>
                                <div class="character-leg" style="background: ${traits.hasPants ? traits.pants : traits.skin};">
                                    ${traits.hasPants ? `<div class="nft-pants" style="background: ${traits.pants};"></div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="character-info">
                    <div class="character-name">${character.first_name} ${character.last_name}</div>
                    <div class="character-dates">
                        <div class="birth-date">üéÇ ${formatDate(character.birth_timestamp)}</div>
                        ${!character.is_alive ? `<div class="death-date">‚ö±Ô∏è ${formatDate(character.death_timestamp)}</div>` : ''}
                    </div>
                </div>
            `;
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            return new Date(timestamp).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        async function loadFamilyTreeData() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const container = document.getElementById('dynasties-container');

            // Show loading
            loading.style.display = 'block';
            error.style.display = 'none';
            container.style.display = 'none';

            try {
                let characterData;

                if (USE_STATIC_DATA) {
                    // Load from static JSON file for production
                    console.log('üìÅ Loading character data from JSON file...');
                    const charactersRes = await fetch('./characters.json');

                    if (!charactersRes.ok) {
                        throw new Error(`Failed to load characters.json: ${charactersRes.status}`);
                    }

                    characterData = await charactersRes.json();
                    console.log('‚úÖ Successfully loaded static character data:', characterData);
                } else {
                    // Try to load from live API (development mode)
                    console.log('üîó Attempting to connect to FishTank API...');
                    const charactersRes = await fetch(`${API_BASE}/api/characters`);

                    if (!charactersRes.ok) {
                        throw new Error(`API returned ${charactersRes.status}: ${charactersRes.statusText}`);
                    }

                    characterData = await charactersRes.json();
                    console.log('‚úÖ Successfully loaded live character data:', characterData);
                }

                allCharacters = characterData.characters || [];

                loading.style.display = 'none';
                displayNFTFamilyTree(characterData, {});
                container.style.display = 'grid';

                console.log('üé® NFT Family Tree rendered with live data!');

            } catch (err) {
                console.error('‚ùå Failed to load live data:', err);
                loading.style.display = 'none';

                // Handle different types of errors
                if (isLocalFile) {
                    error.innerHTML = `
                        <h3>üè† Local Development Mode</h3>
                        <p><strong>Running from local file system</strong></p>
                        <p>‚ú® This shows the professional NFT design and functionality</p>
                        <p>üöÄ When deployed to GitHub/Cloudflare, it will load real character data from JSON</p>
                        <p><em>Displaying sample NFT family tree for preview...</em></p>
                    `;
                } else if (USE_STATIC_DATA) {
                    error.innerHTML = `
                        <h3>üìÅ Data Loading Error</h3>
                        <p><strong>Cannot load characters.json:</strong> ${err.message}</p>
                        <p>Make sure the characters.json file is deployed with the HTML file.</p>
                        <p><em>Showing sample NFT layout for now...</em></p>
                    `;
                } else {
                    error.innerHTML = `
                        <h3>üîå API Connection Error</h3>
                        <p><strong>Cannot connect to FishTank API:</strong> ${err.message}</p>
                        <p>Make sure FishTank is running with: <code>npm start</code></p>
                        <p><em>Showing sample NFT layout for now...</em></p>
                    `;
                }

                error.style.display = 'block';
                displaySampleDynasties();
                container.style.display = 'grid';
            }
        }

        function displaySampleDynasties() {
            const container = document.getElementById('dynasties-container');

            // Create sample dynasties to show the layout
            container.innerHTML = `
                <div class="dynasty">
                    <div class="dynasty-header">
                        <div class="dynasty-title">Dynasty 1 - The Diamond Hands</div>
                    </div>
                    <div class="founding-father">
                        ${createSamplePortrait('Crypto Chad', '2024-01-15', null, true)}
                    </div>
                    <div class="descendants">
                        <div class="generation-label">Generation 1</div>
                        <div class="generation">
                            ${createSamplePortrait('Moon Walker', '2024-02-20', null)}
                            ${createSamplePortrait('HODL Queen', '2024-03-10', null)}
                        </div>
                        <div class="generation-label">Generation 2</div>
                        <div class="generation">
                            ${createSamplePortrait('Degen Jr.', '2024-04-05', '2024-05-15')}
                            ${createSamplePortrait('Paper Hands', '2024-04-12', '2024-04-13')}
                            ${createSamplePortrait('Diamond Baby', '2024-05-01', null)}
                        </div>
                    </div>
                </div>

                <div class="dynasty">
                    <div class="dynasty-header">
                        <div class="dynasty-title">Dynasty 2 - The Whale Watchers</div>
                    </div>
                    <div class="founding-father">
                        ${createSamplePortrait('Whale Hunter', '2024-01-20', null, true)}
                    </div>
                    <div class="descendants">
                        <div class="generation-label">Generation 1</div>
                        <div class="generation">
                            ${createSamplePortrait('Pump Master', '2024-02-28', null)}
                        </div>
                    </div>
                </div>

                <div class="dynasty">
                    <div class="dynasty-header">
                        <div class="dynasty-title">Dynasty 3 - The FUD Fighters</div>
                    </div>
                    <div class="founding-father">
                        ${createSamplePortrait('Anti-FUD', '2024-01-25', null, true)}
                    </div>
                    <div class="descendants">
                        <div class="generation-label">Generation 1</div>
                        <div class="generation">
                            ${createSamplePortrait('Hopium Dealer', '2024-03-15', null)}
                            ${createSamplePortrait('Copium Addict', '2024-03-20', '2024-04-01')}
                        </div>
                    </div>
                </div>
            `;
        }

        function createSamplePortrait(name, birthDate, deathDate, isFounder = false) {
            // Create more realistic sample traits
            const rarities = ['common', 'uncommon', 'rare', 'epic', 'legendary', 'mythic'];
            const rarity = rarities[Math.floor(Math.random() * rarities.length)];
            const sampleTraits = {
                hat: NFT_TRAITS.hatColors[rarity] ? NFT_TRAITS.hatColors[rarity][0] : '#8B4513',
                shirt: NFT_TRAITS.shirtColors[rarity] ? NFT_TRAITS.shirtColors[rarity][0] : '#696969',
                pants: NFT_TRAITS.pantsColors[rarity] ? NFT_TRAITS.pantsColors[rarity][0] : '#2C3E50',
                skin: NFT_TRAITS.skinTones[Math.floor(Math.random() * NFT_TRAITS.skinTones.length)],
                rarity: rarity,
                hasHat: Math.random() > 0.25,
                hasShirt: Math.random() > 0.33,
                hasPants: Math.random() > 0.5,
                specialEffect: NFT_TRAITS.specialEffects[rarity] ?
                    NFT_TRAITS.specialEffects[rarity][0] : null
            };

            const portraitSize = isFounder ? 'character-portrait' : 'character-portrait descendant-portrait';
            const isAlive = !deathDate;

            return `
                <div class="${portraitSize} ${isAlive ? 'status-alive' : 'status-dead'} ${sampleTraits.specialEffect ? `effect-${sampleTraits.specialEffect}` : ''}"
                     onclick="showSampleModal('${name}', '${birthDate}', '${deathDate}')">

                    <div class="nft-rarity rarity-${sampleTraits.rarity}"></div>

                    <div class="portrait-avatar bg-${sampleTraits.rarity}">
                        <div class="character-body">
                            <div class="character-head" style="background: ${sampleTraits.skin};">
                                ${sampleTraits.hasHat ? `<div class="nft-hat" style="background: ${sampleTraits.hat};"></div>` : ''}
                            </div>
                            <div class="character-torso" style="background: ${sampleTraits.skin};">
                                ${sampleTraits.hasShirt ? `<div class="nft-shirt" style="background: ${sampleTraits.shirt};"></div>` : ''}
                                <div class="character-arms" style="background: ${sampleTraits.skin};"></div>
                            </div>
                            <div class="character-legs">
                                <div class="character-leg" style="background: ${sampleTraits.hasPants ? sampleTraits.pants : sampleTraits.skin};">
                                    ${sampleTraits.hasPants ? `<div class="nft-pants" style="background: ${sampleTraits.pants};"></div>` : ''}
                                </div>
                                <div class="character-leg" style="background: ${sampleTraits.hasPants ? sampleTraits.pants : sampleTraits.skin};">
                                    ${sampleTraits.hasPants ? `<div class="nft-pants" style="background: ${sampleTraits.pants};"></div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="character-info">
                    <div class="character-name">${name}</div>
                    <div class="character-dates">
                        <div class="birth-date">üéÇ ${formatDateString(birthDate)}</div>
                        ${deathDate ? `<div class="death-date">‚ö±Ô∏è ${formatDateString(deathDate)}</div>` : ''}
                    </div>
                </div>
            `;
        }

        function formatDateString(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function showSampleModal(name, birthDate, deathDate) {
            const modal = document.getElementById('characterModal');
            const modalContent = document.getElementById('modalContent');

            modalContent.innerHTML = `
                <h2>üé≠ ${name}</h2>
                <div class="modal-portrait">
                    <div class="modal-avatar status-${deathDate ? 'dead' : 'alive'}" style="background: linear-gradient(135deg, #D4AF37, #B8860B);"></div>
                    <div class="modal-basic-info">
                        <p><strong>Birth:</strong> ${formatDateString(birthDate)}</p>
                        ${deathDate ? `<p><strong>Death:</strong> ${formatDateString(deathDate)}</p>` : '<p><strong>Status:</strong> üíö Living</p>'}
                        <p><strong>NFT Rarity:</strong> Rare</p>
                    </div>
                </div>

                <div class="modal-details">
                    <div class="detail-card">
                        <div class="detail-label">üé≠ Personality</div>
                        <div class="detail-value">Diamond-handed optimist</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">üíº Occupation</div>
                        <div class="detail-value">Professional HODLer</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">ü™ô Holdings</div>
                        <div class="detail-value">1,000,000 tokens</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">üí∞ Investment</div>
                        <div class="detail-value">$50,000</div>
                    </div>
                </div>

                <div class="interactions-section">
                    <h3>üé™ Recent Interactions</h3>
                    <p><em>Sample character interactions will appear here when the system is active...</em></p>
                </div>
            `;

            modal.style.display = 'block';
        }

        function displayNFTFamilyTree(characterData, familyTreeData) {
            const container = document.getElementById('dynasties-container');

            if (!characterData.characters || characterData.characters.length === 0) {
                displaySampleDynasties();
                return;
            }

            // Group characters by family/dynasty (for now, use first letter of name)
            const dynasties = {};
            characterData.characters.forEach(character => {
                const dynastyKey = character.first_name.charAt(0).toUpperCase();
                if (!dynasties[dynastyKey]) {
                    dynasties[dynastyKey] = [];
                }
                dynasties[dynastyKey].push(character);
            });

            // Create dynasty display
            let dynastyHTML = '';
            Object.keys(dynasties).slice(0, 6).forEach((dynastyKey, index) => {
                const characters = dynasties[dynastyKey];
                const founder = characters[0]; // First character as founder
                const descendants = characters.slice(1);

                dynastyHTML += `
                    <div class="dynasty">
                        <div class="dynasty-header">
                            <div class="dynasty-title">Dynasty ${index + 1} - The ${dynastyKey} Clan</div>
                        </div>
                        <div class="founding-father">
                            ${createCharacterPortrait(founder, true)}
                        </div>
                        <div class="descendants">
                            ${descendants.length > 0 ? `
                                <div class="generation-label">Generation 1</div>
                                <div class="generation">
                                    ${descendants.slice(0, 4).map(char => createCharacterPortrait(char, false)).join('')}
                                </div>
                            ` : ''}
                            ${descendants.length > 4 ? `
                                <div class="generation-label">Generation 2</div>
                                <div class="generation">
                                    ${descendants.slice(4, 8).map(char => createCharacterPortrait(char, false)).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = dynastyHTML;
        }

        // Modal functionality
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('characterModal');
            const closeBtn = document.getElementsByClassName('close')[0];

            closeBtn.onclick = () => modal.style.display = 'none';
            window.onclick = (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            };

            loadFamilyTreeData();
        });

        function openCharacterModal(characterId) {
            const character = allCharacters.find(c => c.id == characterId);
            if (!character) {
                showSampleModal('Sample Character', '2024-01-01', null);
                return;
            }

            const modal = document.getElementById('characterModal');
            const modalContent = document.getElementById('modalContent');
            const traits = generateNFTTraits(character);

            modalContent.innerHTML = `
                <h2>üé≠ ${character.first_name} ${character.last_name}</h2>
                <div class="modal-portrait">
                    <div class="modal-avatar bg-${traits.rarity}" style="width: 100px; height: 100px; border-radius: 15px;"></div>
                    <div class="modal-basic-info">
                        <p><strong>Nickname:</strong> "${character.nickname}"</p>
                        <p><strong>Birth:</strong> ${formatDate(character.birth_timestamp)}</p>
                        ${!character.is_alive ? `<p><strong>Death:</strong> ${formatDate(character.death_timestamp)}</p>` : '<p><strong>Status:</strong> üíö Living</p>'}
                        <p><strong>NFT Rarity:</strong> <span style="color: var(--rarity-color); font-weight: bold; text-transform: uppercase;">${traits.rarity}</span></p>
                    </div>
                </div>

                <div class="modal-details">
                    <div class="detail-card">
                        <div class="detail-label">üé≠ Personality</div>
                        <div class="detail-value">${character.personality || 'Mysterious trader'}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">üíº Occupation</div>
                        <div class="detail-value">${character.occupation || 'Professional HODLer'}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">üß¨ Age</div>
                        <div class="detail-value">${character.age || 'Unknown'} years</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">‚ößÔ∏è Gender</div>
                        <div class="detail-value">${character.gender || 'Unknown'}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">ü™ô Holdings</div>
                        <div class="detail-value">${character.current_holding?.toLocaleString() || '0'} tokens</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">üí∞ Investment</div>
                        <div class="detail-value">$${character.total_investment?.toLocaleString() || '0'}</div>
                    </div>
                    ${!character.is_alive && character.death_cause ? `
                        <div class="detail-card">
                            <div class="detail-label">üíÄ Cause of Death</div>
                            <div class="detail-value">${character.death_cause}</div>
                        </div>
                    ` : ''}
                </div>

                <div class="interactions-section">
                    <h3>üé™ Recent Interactions</h3>
                    <p><em>Character interactions will appear here when the interaction system is active...</em></p>
                </div>
            `;

            modal.style.display = 'block';
        }
    </script>
</body>
</html>